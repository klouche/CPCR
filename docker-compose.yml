services:
  db:
    image: pgvector/pgvector:pg17
    container_name: cpcr-db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: cpcr
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./docker/db/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d cpcr"]
      interval: 5s
      timeout: 3s
      retries: 20

  embeddings:
    image: ghcr.io/huggingface/text-embeddings-inference:cpu-1.8.1
    platform: linux/amd64
    container_name: cpcr-embeddings
    command: ["--model-id", "intfloat/multilingual-e5-small"]
    ports:
      - "8080:80"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:80/health || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 30

  app:
    build: .
    container_name: cpcr-app
    depends_on:
      db:
        condition: service_healthy
      embeddings:
        condition: service_healthy
    environment:
      NODE_ENV: production
      PORT: 3000
      HOST: 0.0.0.0

      # Prisma / Postgres
      DATABASE_URL: postgresql://postgres:postgres@db:5432/cpcr?schema=public

      # Session + CORS
      SESSION_SECRET: ${SESSION_SECRET:-dev-secret-change-me}
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS:-http://localhost:3000}

      # Embeddings server
      EMBEDDINGS_BASE_URL: http://embeddings:80
      EMBEDDING_MODEL_ID: intfloat/multilingual-e5-small
      EMBEDDING_DIM: "384"

      # Keep these for now if you still use them elsewhere
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      PINECONE_API_KEY: ${PINECONE_API_KEY:-}
      PINECONE_INDEX: ${PINECONE_INDEX:-}
      CROSS_SITE_COOKIES: ${CROSS_SITE_COOKIES:-false}

    ports:
      - "3000:3000"

volumes:
  pgdata:
  hfdata: